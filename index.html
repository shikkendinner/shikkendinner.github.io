<!DOCTYPE html>
<html ng-app="testApp">

<head>
	<meta charset="utf-8">
	<title>Angular JS</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
	<!-- QR CODE DECODER LIBRARIES -->
	<script src="libs/jsQR.js"></script>
</head>

<body ng-controller="TestController">
	<h1>Test App</h1>
	<hr />
	<h3>Camera Upload Solution</h3>
	<input type="file" accept="image/*" capture>
	<h3>QR Code Scan</h3>
	<div class="camera">
		<video id="video">Video stream not available.</video>
		<button id="startbutton">Scan Code</button>
	</div>
	<canvas id="canvas"></canvas>
	<h4>Result of the scan</h4>
	<div class="output">{{result}}</div>
</body>

<script>
	var testApp = angular.module("testApp", []);

	testApp.controller("TestController", ["$scope", "$window", ($scope, $window) => {
		// The width and height of the captured photo. We will set the
		// width to the value defined here, but the height will be
		// calculated based on the aspect ratio of the input stream.
		$scope.width = 320;    // We will scale the photo width to this
		$scope.height = 0;     // This will be computed based on the input stream

		// |streaming| indicates whether or not we're currently streaming
		// video from the camera. Obviously, we start at false.
		$scope.streaming = false;

		// The various HTML elements we need to configure or control. These
		// will be set by the startup() function.
		$scope.video = null;
		$scope.canvas = null;
		$scope.startbutton = null;
		$scope.result = null;

		$scope.startup = function () {
			$scope.video = document.getElementById('video');
			$scope.canvas = document.getElementById('canvas');
			$scope.startbutton = document.getElementById('startbutton');

			navigator.mediaDevices.getUserMedia({ video: true, audio: false })
				.then(function (stream) {
					$scope.video.srcObject = stream;
					$scope.video.play();
				})
				.catch(function (err) {
					console.log("An error occurred: " + err);
				});

			$scope.video.addEventListener('canplay', function (ev) {
				if (!$scope.streaming) {
					$scope.height = $scope.video.videoHeight / ($scope.video.videoWidth / $scope.width);

					// Firefox currently has a bug where the height can't be read from
					// the video, so we will make assumptions if this happens.
					if (isNaN($scope.height)) {
						$scope.height = $scope.width / (4 / 3);
					}

					$scope.video.setAttribute('width', width);
					$scope.video.setAttribute('height', height);
					$scope.canvas.setAttribute('width', width);
					$scope.canvas.setAttribute('height', height);
					$scope.streaming = true;
				}
			}, false);

			$scope.startbutton.addEventListener('click', function (ev) {
				$scope.scanCode();
				ev.preventDefault();
			}, false);

			$scope.reset();
		}

		$scope.reset = function () {
			var context = $scope.canvas.getContext('2d');
			context.fillStyle = "#AAA";
			context.fillRect(0, 0, $scope.canvas.width, $scope.canvas.height);

			$scope.result = "QR Code Scanner Not Running";
		}

		$scope.scanCode = function() {
			$scope.result = "Scanning...";
			var context = $scope.canvas.getContext('2d');
			if ($scope.width && $scope.height) {
				$scope.canvas.width = $scope.width;
				$scope.canvas.height = $scope.height;
				context.drawImage($scope.video, 0, 0, $scope.width, $scope.height);

				var data = context.getImageData();
				var code = jsQR(data, $scope.width, $scope.height);

				if(code) {
					$scope.result = code.data();
				} else {
					$scope.result = "Did not find QR Code";
				}
			} else {
				$scope.reset();
			}
		}

		$window.onload($scope.startup);
	}]);

</script>

</html>